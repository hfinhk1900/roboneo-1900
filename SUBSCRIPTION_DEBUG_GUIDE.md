# è®¢é˜…çŠ¶æ€è°ƒè¯•æŒ‡å—

## æ¦‚è¿°

å½“ç”¨æˆ·å–æ¶ˆè®¢é˜…åä»äº«å—è®¢é˜…ç¦åˆ©æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹å·¥å…·è¿›è¡Œè¯Šæ–­å’Œä¿®å¤ã€‚

## ğŸ”§ è°ƒè¯•å·¥å…·

### 1. Webç•Œé¢è°ƒè¯•å·¥å…·

**è®¿é—®è·¯å¾„**: `/admin/debug/subscription`

**åŠŸèƒ½**:
- **ç”¨æˆ·æŸ¥æ‰¾**: æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·IDï¼Œæ”¯æŒæ¨¡ç³Šæœç´¢
- **è®¢é˜…è¯Šæ–­**: å¿«é€Ÿæ£€æŸ¥ç”¨æˆ·è®¢é˜…çŠ¶æ€
- **æ•°æ®å¯¹æ¯”**: æŸ¥çœ‹ç”¨æˆ·æ‰€æœ‰æ”¯ä»˜è®°å½•
- **çŠ¶æ€éªŒè¯**: å¯¹æ¯”æœ¬åœ°æ•°æ®åº“ä¸Stripeå®æ—¶çŠ¶æ€
- **ä¸€é”®è¯Šæ–­**: å®Œæ•´çš„è®¢é˜…çŠ¶æ€åˆ†æ

**ä½¿ç”¨æ–¹æ³•**:
1. ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•
2. è®¿é—® `/admin/debug/subscription`
3. **æ–¹å¼A**: åœ¨"ç”¨æˆ·æŸ¥æ‰¾"åŒºåŸŸè¾“å…¥é‚®ç®±æˆ–æœç´¢è¯ï¼Œç‚¹å‡»æŸ¥æ‰¾
4. **æ–¹å¼B**: ç›´æ¥åœ¨"è®¢é˜…è°ƒè¯•"åŒºåŸŸè¾“å…¥ç”¨æˆ·ID
5. ç‚¹å‡»"å®Œæ•´è¯Šæ–­"æˆ–é€‰æ‹©ç‰¹å®šæ£€æŸ¥é¡¹

**ç”¨æˆ·æŸ¥æ‰¾åŠŸèƒ½**:
- é€šè¿‡é‚®ç®±ç²¾ç¡®æŸ¥æ‰¾ç”¨æˆ·
- æ¨¡ç³Šæœç´¢ï¼ˆæ”¯æŒé‚®ç®±ã€å§“åã€ç”¨æˆ·IDï¼‰
- æ˜¾ç¤ºæœç´¢ç»“æœåˆ—è¡¨ï¼Œç‚¹å‡»é€‰æ‹©ç”¨æˆ·
- è‡ªåŠ¨å¡«å……ç”¨æˆ·IDåˆ°è°ƒè¯•åŒºåŸŸ

### 2. æµè§ˆå™¨æ§åˆ¶å°è°ƒè¯•

#### 2A. ç”¨æˆ·æŸ¥æ‰¾è„šæœ¬
**è„šæœ¬æ–‡ä»¶**: `user-lookup.js`

**ä½¿ç”¨æ–¹æ³•**:
```javascript
// 1. åŠ è½½ç”¨æˆ·æŸ¥æ‰¾è„šæœ¬
const script = document.createElement('script');
script.src = '/user-lookup.js';
document.head.appendChild(script);

// 2. ä½¿ç”¨å„ç§æŸ¥æ‰¾åŠŸèƒ½:
findUserByEmail('user@example.com');           // æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·ID
searchUsers('john');                           // æ¨¡ç³Šæœç´¢ç”¨æˆ·
quickDiagnose('user@example.com');            // å¿«é€Ÿè¯Šæ–­ï¼ˆæ”¯æŒé‚®ç®±æˆ–IDï¼‰
batchFindUsers(['email1@example.com', 'email2@example.com']); // æ‰¹é‡æŸ¥æ‰¾
```

#### 2B. è®¢é˜…è¯Šæ–­è„šæœ¬
**è„šæœ¬æ–‡ä»¶**: `debug-subscription-status.js`

**ä½¿ç”¨æ–¹æ³•**:
```javascript
// 1. åŠ è½½è®¢é˜…è¯Šæ–­è„šæœ¬
const script = document.createElement('script');
script.src = '/debug-subscription-status.js';
document.head.appendChild(script);

// 2. æ‰§è¡Œå®Œæ•´è¯Šæ–­:
debugSubscriptionStatus('ç”¨æˆ·ID');
```

### 3. APIç›´æ¥è°ƒç”¨

**ç«¯ç‚¹**: `/api/debug/subscription-status`

**æ”¯æŒçš„æ“ä½œ**:
- `findUserByEmail`: æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·IDå’ŒåŸºæœ¬ä¿¡æ¯
- `searchUsers`: æ¨¡ç³Šæœç´¢ç”¨æˆ·ï¼ˆé‚®ç®±ã€å§“åã€IDï¼‰
- `getActiveSubscription`: è·å–æ´»è·ƒè®¢é˜…
- `getAllPayments`: è·å–æ‰€æœ‰æ”¯ä»˜è®°å½•
- `checkStripeStatus`: éªŒè¯Stripeå®æ—¶çŠ¶æ€

**ç¤ºä¾‹è¯·æ±‚**:
```bash
# æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·
curl -X POST /api/debug/subscription-status \
  -H "Content-Type: application/json" \
  -d '{"action": "findUserByEmail", "email": "user@example.com"}'

# æœç´¢ç”¨æˆ·
curl -X POST /api/debug/subscription-status \
  -H "Content-Type: application/json" \
  -d '{"action": "searchUsers", "searchTerm": "john"}'

# æ£€æŸ¥è®¢é˜…çŠ¶æ€
curl -X POST /api/debug/subscription-status \
  -H "Content-Type: application/json" \
  -d '{"userId": "ç”¨æˆ·ID", "action": "getActiveSubscription"}'
```

### 4. æ•°æ®åº“ç›´æ¥æŸ¥è¯¢

**æ–‡ä»¶**: `debug-subscription-sql.sql`

åŒ…å«10ä¸ªå¸¸ç”¨çš„SQLæŸ¥è¯¢ï¼Œç”¨äºï¼š
- æŸ¥çœ‹ç”¨æˆ·æ”¯ä»˜è®°å½•
- æ£€æŸ¥æ´»è·ƒ/å–æ¶ˆçš„è®¢é˜…
- å‘ç°æ•°æ®ä¸ä¸€è‡´é—®é¢˜
- ç»Ÿè®¡è®¢é˜…çŠ¶æ€åˆ†å¸ƒ

**ä½¿ç”¨æ–¹æ³•**:
1. è¿æ¥åˆ°PostgreSQLæ•°æ®åº“
2. å°†SQLæ–‡ä»¶ä¸­çš„'USER_ID'æ›¿æ¢ä¸ºå®é™…ç”¨æˆ·ID
3. æ‰§è¡Œç›¸åº”çš„æŸ¥è¯¢è¯­å¥

## ğŸ” è¯Šæ–­æµç¨‹

### æ­¥éª¤1: å¿«é€ŸçŠ¶æ€æ£€æŸ¥
```
GET /api/debug/subscription-status?userId=USER_ID
```

### æ­¥éª¤2: è¯¦ç»†è®°å½•åˆ†æ
ä½¿ç”¨Webç•Œé¢æˆ–APIæ£€æŸ¥:
- ç”¨æˆ·çš„æ‰€æœ‰æ”¯ä»˜è®°å½•
- æ¯æ¡è®°å½•çš„çŠ¶æ€å’Œæ—¶é—´æˆ³
- æ˜¯å¦æœ‰å¤šä¸ªè®¢é˜…è®°å½•

### æ­¥éª¤3: StripeçŠ¶æ€éªŒè¯
å¯¹æ¯”æœ¬åœ°æ•°æ®åº“ä¸Stripeå®æ—¶çŠ¶æ€:
- è®¢é˜…çŠ¶æ€æ˜¯å¦ä¸€è‡´
- å–æ¶ˆæ—¶é—´æ˜¯å¦ä¸€è‡´
- æœŸé—´ç»“æŸæ—¶é—´æ˜¯å¦åŒ¹é…

### æ­¥éª¤4: é—®é¢˜å®šä½
æ ¹æ®è¯Šæ–­ç»“æœç¡®å®šé—®é¢˜ç±»å‹:

#### æƒ…å†µA: æ•°æ®åº“çŠ¶æ€æ­£ç¡®ï¼Œä½†é€»è¾‘åˆ¤æ–­é”™è¯¯
- æ£€æŸ¥`getActiveSubscriptionAction`é€»è¾‘
- æ£€æŸ¥è®¢é˜…ç¦åˆ©æ£€æŸ¥é€»è¾‘
- å¯èƒ½å­˜åœ¨ç¼“å­˜é—®é¢˜

#### æƒ…å†µB: æ•°æ®åº“çŠ¶æ€é”™è¯¯
- Webhookå¤„ç†å¤±è´¥
- ç½‘ç»œé—®é¢˜å¯¼è‡´çŠ¶æ€åŒæ­¥å¤±è´¥
- éœ€è¦æ‰‹åŠ¨æ›´æ–°æ•°æ®åº“çŠ¶æ€

#### æƒ…å†µC: Stripeä¸æœ¬åœ°ä¸ä¸€è‡´
- æ£€æŸ¥webhooké…ç½®
- æ£€æŸ¥APIå¯†é’¥å’Œæƒé™
- å¯èƒ½éœ€è¦å¼ºåˆ¶åŒæ­¥

## ğŸ› ï¸ å¸¸è§é—®é¢˜ä¿®å¤

### ä¿®å¤1: æ‰‹åŠ¨æ›´æ–°è®¢é˜…çŠ¶æ€
```sql
UPDATE payment
SET status = 'canceled', updated_at = NOW()
WHERE user_id = 'USER_ID'
  AND subscription_id = 'SUBSCRIPTION_ID';
```

### ä¿®å¤2: æ¸…é™¤ç¼“å­˜
```javascript
// å¦‚æœä½¿ç”¨äº†å®¢æˆ·ç«¯ç¼“å­˜
localStorage.clear();
sessionStorage.clear();

// å¼ºåˆ¶é¡µé¢åˆ·æ–°
window.location.reload();
```

### ä¿®å¤3: é‡æ–°åŒæ­¥StripeçŠ¶æ€
```javascript
// é€šè¿‡APIå¼ºåˆ¶åŒæ­¥
fetch('/api/debug/subscription-status', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    userId: 'USER_ID',
    action: 'checkStripeStatus'
  })
});
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### Webhooké…ç½®æ£€æŸ¥
- [ ] Stripe Dashboardä¸­webhookç«¯ç‚¹å·²é…ç½®
- [ ] åŒ…å«`customer.subscription.deleted`äº‹ä»¶
- [ ] Webhookå¯†é’¥æ­£ç¡®è®¾ç½®
- [ ] ç«¯ç‚¹URLå¯è®¿é—®

### æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥
- [ ] paymentè¡¨æœ‰å¯¹åº”çš„è®¢é˜…è®°å½•
- [ ] çŠ¶æ€å­—æ®µå€¼æ­£ç¡®
- [ ] æ—¶é—´æˆ³å­—æ®µå‡†ç¡®
- [ ] å¤–é”®å…³è”å®Œæ•´

### ä»£ç é€»è¾‘æ£€æŸ¥
- [ ] `getActiveSubscriptionAction`æŸ¥è¯¢æ¡ä»¶æ­£ç¡®
- [ ] è®¢é˜…ç¦åˆ©æ£€æŸ¥é€»è¾‘æ­£ç¡®
- [ ] ç¼“å­˜å¤„ç†æœºåˆ¶æ­£å¸¸
- [ ] é”™è¯¯å¤„ç†å®Œå–„

## ğŸš¨ ç´§æ€¥ä¿®å¤

å¦‚æœå‘ç°å¤§é‡ç”¨æˆ·å—å½±å“ï¼Œå¯ä»¥æ‰§è¡Œæ‰¹é‡ä¿®å¤ï¼š

### 1. æ‰¹é‡åŒæ­¥StripeçŠ¶æ€
```sql
-- æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½æœ‰é—®é¢˜çš„è®°å½•
SELECT user_id, subscription_id
FROM payment
WHERE status = 'active'
  AND updated_at < NOW() - INTERVAL '1 day';
```

### 2. æ‰¹é‡æ›´æ–°è¿‡æœŸè®¢é˜…
```sql
-- æ›´æ–°å·²è¿‡æœŸä½†çŠ¶æ€ä»ä¸ºactiveçš„è®¢é˜…
UPDATE payment
SET status = 'canceled', updated_at = NOW()
WHERE status = 'active'
  AND period_end < NOW();
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœä»¥ä¸Šå·¥å…·æ— æ³•è§£å†³é—®é¢˜ï¼š

1. æ”¶é›†å®Œæ•´çš„è¯Šæ–­æ—¥å¿—
2. è®°å½•å…·ä½“çš„ç”¨æˆ·IDå’Œè®¢é˜…ID
3. å¯¼å‡ºç›¸å…³çš„æ•°æ®åº“è®°å½•
4. æ£€æŸ¥Stripe Dashboardçš„äº‹ä»¶æ—¥å¿—
5. è”ç³»æŠ€æœ¯å›¢é˜Ÿè¿›è¡Œæ·±å…¥åˆ†æ

## ğŸ”„ é¢„é˜²æªæ–½

ä¸ºé˜²æ­¢æ­¤ç±»é—®é¢˜å†æ¬¡å‘ç”Ÿï¼š

1. **ç›‘æ§Webhookå¥åº·çŠ¶æ€**
   - è®¾ç½®Webhookå¤±è´¥å‘Šè­¦
   - å®šæœŸæ£€æŸ¥å¤„ç†æ—¥å¿—

2. **å®šæœŸæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**
   - æ¯æ—¥å¯¹æ¯”æœ¬åœ°ä¸StripeçŠ¶æ€
   - è‡ªåŠ¨ä¿®å¤æ˜æ˜¾çš„ä¸ä¸€è‡´

3. **æ”¹è¿›é”™è¯¯å¤„ç†**
   - å¢å¼ºWebhooké‡è¯•æœºåˆ¶
   - æ·»åŠ æ‰‹åŠ¨åŒæ­¥åŠŸèƒ½

4. **å¢å¼ºæ—¥å¿—è®°å½•**
   - è®°å½•æ‰€æœ‰è®¢é˜…çŠ¶æ€å˜æ›´
   - ä¿ç•™è¯¦ç»†çš„æ“ä½œå®¡è®¡æ—¥å¿—
